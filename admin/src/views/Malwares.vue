<template>
  <section
    class="section"
  >
    <h2
      class="title mb-0"
    >
      {{ $t("malwares") }}
      <div class="level">
        <div class="level-left subtitle">
          {{ $t("subtitle.malware") }}
        </div>

        <div class="level-right">
          <button
            :disabled="B.scopes['create:malwares'] ? false : true"
            class="button is-primary"
            @click.prevent="create"
          >
            <octicon :icon="plus" /> <span>{{ $t('newMalware') }}</span>
          </button>
        </div>
      </div>
    </h2>
    <box>
      <div>
        <input
          v-model="filterString"
          class="input"
          type="search"
          :class="queryFailed?'is-danger':''"
          required
          placeholder="Filter records"
        >
      </div>

      <data-table
        ref="table"
        :key="currentLocale"
        :items="items"
        :theme="$_ui_theme_tables"
        sort-by="id"
        :filter.sync="filterString"
      >
        <data-column
          field="md5"
          :label="$t('md5')"
          :sortable="false"
        >
          <template slot-scope="{ value }">
            <div
              style="display: flex"
            >
              <pre style="width: 100%"> {{ value }}</pre>
              <span
                style="margin: auto; padding: 0.5rem"
                @click="copyToken(value)"
              >
                <octicon
                  :icon="clippy"
                />
              </span>
            </div>
          </template>
        </data-column>
        <data-column
          field="sha1"
          :label="$t('sha1')"
          :sortable="false"
        >
          <template slot-scope="{ value }">
            <div
              style="display: flex"
            >
              <pre style="width: 100%"> {{ value }}</pre>
              <span
                style="margin: auto; padding: 0.5rem"
                @click="copyToken(value)"
              >
                <octicon
                  :icon="clippy"
                />
              </span>
            </div>
          </template>
        </data-column>
        <data-column
          field="sha256"
          :label="$t('sha256')"
          :sortable="false"
        >
          <template slot-scope="{ value }">
            <div
              style="display: flex"
            >
              <pre style="width: 100%"> {{ value }}</pre>
              <span
                style="margin: auto; padding: 0.5rem"
                @click="copyToken(value)"
              >
                <octicon
                  :icon="clippy"
                />
              </span>
            </div>
          </template>
        </data-column>
        <data-column
          field="source"
          :label="$t('source')"
          :sortable="false"
        />
        <data-column
          :label="$t('actions')"
          class="has-text-centered"
          :sortable="false"
          width="20%"
        >
          <template slot-scope="props">
            <div class="has-text-centered">
              <button
                :disabled="B.scopes['update:malwares'] ? false : true"
                class="button is-text"
                @click.prevent="edit(props.item)"
              >
                <octicon :icon="pencil" /> <span>{{ $t('edit') }}</span>
              </button>
              <button
                :disabled="B.scopes['delete:malwares'] ? false : true"
                class="button is-text"
                @click.prevent="destroy(props.item.id)"
              >
                <octicon :icon="x" /> <span>{{ $t('delete') }}</span>
              </button>
            </div>
          </template>
        </data-column>
      </data-table>
    </box>
    <modal :show.sync="modal">
      <box>
        <div
          slot="header"
          style="color: '#dddddf' !important"
        >
          {{ item.id ?$t('editMalware'): $t("newMalware") }}
        </div>
        <form @submit.prevent="submit">
          <template>
            <div>
              <div
                v-if="!item.id"
                class="field"
              >
                <label class="label">{{ $t("type") }}</label>
                <v-select
                  v-model="item.type"
                  :options="destinations"
                  :clearable="false"
                >
                  <template #search="{attributes, events}">
                    <input
                      class="vs__search"
                      :required="!item.type"
                      v-bind="attributes"
                      v-on="events"
                    >
                  </template>
                </v-select>
              </div>
              <div
                v-if="item.type === 'info'"
                class="field"
              >
                <label class="label">{{ $t("md5") }}</label>
                <div class="control">
                  <input
                    v-model="item.md5"
                    class="input"
                    type="text"
                    required
                  >
                </div>
              </div>
              <div
                v-if="item.type === 'info'"
                class="field"
              >
                <label class="label">{{ $t("sha1") }}</label>
                <div class="control">
                  <input
                    v-model="item.sha1"
                    class="input"
                    type="text"
                  >
                </div>
              </div>
              <div
                v-if="item.type === 'info'"
                class="field"
              >
                <label class="label">{{ $t("sha256") }}</label>
                <div class="control">
                  <input
                    v-model="item.sha256"
                    class="input"
                    type="text"
                  >
                </div>
              </div>
              <div
                v-if="item.type === 'file'"
                class="field"
              >
                <label class="label">{{ $t("file") }}</label>
                <div class="control">
                  <input
                    class="input"
                    type="file"
                    @change="previewFiles"
                  >
                </div>
              </div>
            </div>
          </template>
          <div
            slot="footer"
            class="border-top field columns mt-2"
          >
            <div class="column has-text-justified">
              <button
                type="button"
                class="button is-small is-danger is-light"
                @click.prevent="modal = !modal"
              >
                {{ $t("cancel") }}
              </button>
            </div>
            <div class="column is-narrow">
              <button
                class="button is-small is-link is-light"
                type="submit"
              >
                {{ $t("save") }}
              </button>
            </div>
          </div>
        </form>
      </box>
    </modal>
  </section>
</template>
<script>
import { DataTable, DataColumn, Modal } from '@cyradar/ui'
import { plus, x, pencil, clock, clippy } from 'octicons-vue'
import vSelect from 'vue-select'
import 'vue-select/dist/vue-select.css'
import clipboard from '@/clipboard.js'
import alertify from 'alertify.js'
import { B } from '../global.js'
import { mapGetters } from 'vuex'

export default {
  components: { DataTable, DataColumn, vSelect, Modal },
  data () {
    return {
      modal: false,
      item: {
        type: 'info',
        file: '',
        id: ''
      },
      destinations: ['info', 'file'],
      filter: {},
      filterString: '',
      B,
      queryFailed: false
    }
  },
  computed: {
    plus () {
      return plus
    },
    x () {
      return x
    },
    clock () {
      return clock
    },
    pencil () {
      return pencil
    },
    clippy () {
      return clippy
    },
    ...mapGetters([
      'currentLocale'
    ])
  },
  methods: {
    items (filter, order, pagination) {
      if (!filter.query.trim()) {
        this.queryFailed = false
      }

      if (filter.query !== this.convertObjectToString(this.filter)) {
        this.filter = this.converStringToObject(filter.query)
      }

      return this.$http.get('/api/v1/malware', {
        params: {
          filter: this.filter ? this.filter : {},
          order: order.order,
          sort: order.order,
          page: pagination.page,
          perPage: pagination.perPage
        }
      }).then(body => {
        if (!body || !body.data) {
          return {}
        }

        return body.data.data
      })
    },
    create () {
      this.modal = !this.modal
      this.item = {
        type: 'info'
      }
    },
    edit (props) {
      this.modal = !this.modal
      this.item = props
      this.item.type = 'info'
    },
    submit () {
      this.modal = !this.modal
      if (!this.item.id && this.item.type === 'info') {
        return this.$http.post(`/api/v1/malware/info`, this.item).then(body => {
          if (!body || !body.data) {
            return
          }

          this.$store.dispatch('NOTIFY', {
            type: 'success',
            text: body.data.message
          })

          this.$refs.table.loadItems()
        })
      }
      if (!this.item.id && this.item.type === 'file') {
        let formData = new FormData()
        formData.append('file', this.fileData)
        return this.$http.post(`api/v1/malware/file`, formData, { headers: { 'Content-Type': 'multipart/form-data' }, timeout: 600000 }).then(body => {
          if (!body || !body.data) {
            return
          }
          this.$store.dispatch('NOTIFY', {
            type: 'success',
            text: body.data.message
          })

          this.$refs.table.loadItems()
        })
      }
      return this.$http.patch(`/api/v1/malware/${this.item.id}`, this.item).then(body => {
        if (!body || !body.data) {
          return
        }

        this.$store.dispatch('NOTIFY', {
          type: 'success',
          text: body.data.message
        })

        this.$refs.table.loadItems()
      })
    },
    previewFiles (event) {
      this.fileData = event.target.files[0]
      this.dbFileName = event.target.files[0].name
    },
    destroy (id) {
      alertify.confirm(this.$t('messageDelete'), () => {
        return this.$http.delete(`/api/v1/malware/${id}`).then(body => {
          if (!body || !body.data) {
            return
          }

          this.$store.dispatch('NOTIFY', {
            type: 'success',
            text: body.data.message
          })

          this.$refs.table.loadItems()
        })
      })
    },
    copyToken (text) {
      clipboard(text)
      this.$store.dispatch('NOTIFY', {
        type: 'success',
        text: this.$t('copyToClipboard')
      })
    },
    bindFilter (val, key) {
      if (!key) {
        return
      }
      this.queryFailed = false

      this.filter[key] = val
      this.filterString = this.convertObjectToString(this.filter)
    },
    convertObjectToString (val) {
      if (val === {}) {
        return
      }

      let result = ''
      for (const property in val) {
        if (result) {
          result = result.concat(', ')
        }

        result = result.concat(`${property}: ${val[property]}`)
      }
      return result
    },
    converStringToObject (data) {
      if (!data.trim()) {
        this.queryFailed = false
        return {}
      }

      const regex = /([^,]+)/gm
      const regexParseKey = /([a-zA-Z0-9_ ]+):(.*)/
      let found = data.match(regex)
      let result = {}

      for (let i = 0; i < found.length; i++) {
        if (found[i].trim() === '') {
          continue
        }

        let foundKey = found[i].trim().match(regexParseKey)
        if (!foundKey || foundKey.length !== 3) {
          this.queryFailed = true
          return {}
        }

        result[foundKey[1].trim()] = foundKey[2].trim()
      }
      this.queryFailed = false
      return result
    }

  }
}
</script>
<style lang='scss'>
div[data-elm="filter"]{
  display: none !important;
}

pre {
  padding: 0.5em;
  background: none;
  color: #495057;
}
.dashboard.is-dark pre {
  color: #f2f2f2;
}
.dashboard.is-dark {
  box {
    color: '#dddddf' !important
  }
}
</style>
